 # .htaccess - Configuración de seguridad y redirecciones

# Protección de archivos sensibles
<Files "database.php">
    Require all denied
</Files>

<Files "auth.php">
    <RequireAll>
        Require all granted
        Require not ip 192.168.1.0/24
    </RequireAll>
</Files>

# Redirección automática al login si no está autenticado
RewriteEngine On

# Redireccionar index.html a través de PHP para verificar autenticación
RewriteCond %{REQUEST_FILENAME} ^.*index\.html$
RewriteRule ^index\.html$ check_auth.php [L]

# Permitir acceso directo a login.php
RewriteCond %{REQUEST_FILENAME} ^.*login\.php$
RewriteRule ^login\.php$ - [L]

# Proteger archivos de test y setup - requieren autenticación
RewriteCond %{REQUEST_FILENAME} ^.*(setup|test_voice|test_api)\.php$
RewriteCond %{QUERY_STRING} !authenticated=true
RewriteRule ^(.*)$ auth.php?redirect=$1 [L]

# Seguridad general
# Ocultar información del servidor
ServerTokens Prod
Header always unset X-Powered-By
Header unset X-Powered-By

# Prevenir acceso a archivos de backup
<FilesMatch "\.(bak|backup|swp|tmp)$">
    Require all denied
</FilesMatch>

# Headers de seguridad
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'"

# Prevenir acceso directo a archivos PHP sensibles
<FilesMatch "^(config|database|auth)\.php$">
    <RequireAll>
        Require all granted
        # Solo permitir inclusión desde otros scripts PHP
    </RequireAll>
</FilesMatch>

# Comprimir archivos para mejor rendimiento
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Cache para archivos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
</IfModule>

# Prevenir hotlinking
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?finanzas\.ordenes\.com\.ar [NC]
RewriteRule \.(jpg|jpeg|png|gif|svg|css|js)$ - [F]

# Limitar tamaño de archivos subidos
LimitRequestBody 10485760  # 10MB

# Timeout de sesión
php_value session.gc_maxlifetime 1800  # 30 minutos